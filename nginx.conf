worker_processes 4;
error_log /var/log/nginx/error.log debug;

# Stream configuration for raw TCP connections
stream {
    upstream irc_server {
        server autorack.proxy.rlwy.net:17880;
    }

    server {
        listen 80;
        proxy_connect_timeout 60s;
        proxy_timeout 600s;
        proxy_pass irc_server;
    }
}

events {
    worker_connections 1024;
}

map $remote_addr $anonymized_ip {
    ~(?P<ip>\d+\.\d+\.\d+)\.    $ip.0;
    ~(?P<ip>[^:]+:[^:]+):       $ip::;
    default                     0.0.0.0;
}

server {
    listen 80;
    server_name download.microsoft.com;
    access_log /var/log/nginx/access.log combined_anon;
    
    # Remove identifying headers when proxying
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;
    proxy_hide_header X-AspNet-Version;
    proxy_hide_header X-AspNetMvc-Version;
    
    # Don't pass client IP and other identifiers to upstream
    proxy_set_header X-Forwarded-For "";
    proxy_set_header X-Real-IP "";
    proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36";
    proxy_set_header Referer "";

    proxy_set_header Accept-Encoding "";
    proxy_set_header Accept-Language "en-US";
    proxy_set_header Accept "*/*";
    
    location / {
        proxy_pass http://download.microsoft.com;
        
        # Don't reveal information about your server
        server_tokens off;
    }
}
